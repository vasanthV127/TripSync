================================================================================
                    TRIPSYNC - COLLEGE BUS MANAGEMENT SYSTEM
                          WORKING PRINCIPLE DOCUMENT
================================================================================

PROJECT OVERVIEW
================================================================================

TripSync is a comprehensive college bus management system that connects 
students, drivers, and administrators through a real-time platform. The system 
enables efficient communication, attendance tracking, bus location monitoring, 
and complaint management.


SYSTEM ARCHITECTURE
================================================================================

1. TECHNOLOGY STACK
   - Backend: FastAPI (Python)
   - Database: MongoDB (NoSQL)
   - Authentication: JWT (JSON Web Tokens)
   - Real-time Updates: REST API
   - Location Tracking: GPS Coordinates

2. USER ROLES
   - Students: Track buses, chat with peers, submit complaints
   - Drivers: Send alerts, manage leaves, view assigned students
   - Admin: Complete system control, messaging, assignments


CORE COMPONENTS
================================================================================

1. AUTHENTICATION SYSTEM
   ------------------------
   - JWT-based authentication for secure access
   - Role-based access control (Student, Driver, Admin)
   - Secure password hashing
   - Token expiration and refresh mechanism

   Working Flow:
   User Login → Validate Credentials → Generate JWT Token → 
   Store Token → Use Token for All API Requests

2. USER MANAGEMENT
   ----------------
   Database Collections:
   - users: Stores all user information (students, drivers, admins)
   
   Student Fields:
   - name, roll_no, email, password (hashed)
   - role: "student"
   - route: Assigned bus route
   - boarding: Boarding point
   - assignedBus: Bus number

   Driver Fields:
   - name, email, password, phone
   - role: "driver"
   - Assigned to one bus

   Admin Fields:
   - name, email, password
   - role: "admin"
   - Full system access

3. BUS MANAGEMENT
   ---------------
   Database Collection: buses
   
   Bus Information:
   - number: Unique bus identifier (e.g., "AP39TS1234")
   - route: Assigned route name
   - capacity: Number of seats
   - driverId: Assigned driver ID
   - currentLocation: GPS coordinates
     * latitude
     * longitude
     * timestamp
   - currentStopIndex: Current stop number

   Working Principle:
   - Each bus assigned to one route
   - Each bus has one driver
   - Multiple students assigned to one bus
   - Real-time location updates from driver's device

4. ROUTE MANAGEMENT
   -----------------
   Database Collection: routes
   
   Route Information:
   - name: Route name (e.g., "Vijayawada to VIT AP")
   - stops: Array of stop objects
     * name: Stop name
     * time: Scheduled time
     * latitude: GPS coordinate
     * longitude: GPS coordinate
   - coverageAreas: List of areas covered

   Working Flow:
   Route Created → Buses Assigned → Students Assigned → 
   Driver Assigned → Daily Operations Begin


MESSAGING SYSTEM
================================================================================

1. MESSAGE ARCHITECTURE
   ---------------------
   Database Collections:
   - messages: Stores all messages
   - groups: Stores group metadata

   Group Types:
   a) all_students - Admin to all students
   b) all_drivers - Admin to all drivers
   c) route_students - Admin to route-specific students
   d) route_drivers - Admin to route-specific drivers
   e) driver_to_students - Driver alerts to bus students
   f) bus_students - Student peer-to-peer chat

2. ADMIN MESSAGING
   ----------------
   Capabilities:
   - Broadcast to all students
   - Broadcast to all drivers
   - Send to specific route (students/drivers/parents/all)
   - Send to specific route drivers only

   Working Flow:
   Admin Creates Message → System Identifies Target Group → 
   Message Stored in Database → Recipients Can Access → 
   Real-time Notification (if implemented)

   Use Cases:
   - Campus announcements
   - Emergency alerts
   - Route changes
   - Policy updates

3. DRIVER MESSAGING
   -----------------
   Capabilities:
   - Send alerts to assigned students only
   - View messages from admin
   - One-way communication to students

   Working Flow:
   Driver Detects Issue → Composes Alert → 
   System Identifies Students on Bus → Message Sent → 
   Students Receive Alert

   Use Cases:
   - Bus delays (tire puncture, traffic)
   - Route changes (road work, diversions)
   - Early/late arrivals
   - Bus issues (AC problem, mechanical)

4. STUDENT MESSAGING
   ------------------
   Two Message Sources:

   A) Driver Alerts (Read-Only):
      Endpoint: GET /api/messages/student/driver-messages
      - Receives alerts from bus driver
      - Cannot reply (one-way)
      - Examples: Delays, route changes, issues

   B) Bus Chat (Interactive):
      Endpoint: GET /api/messages/student/bus-chat
      - Chat with 45 other students on same bus
      - Two-way communication
      - Member list included
      - Examples: Study coordination, lost items, questions

   Working Flow:
   Student Opens App → Checks Driver Alerts → 
   Views Bus Chat → Sends Message to Peers → 
   Other Students See Message → Conversation Continues

   Use Cases:
   - Academic discussions
   - Lost and found
   - Event coordination
   - Study groups
   - Bus-related queries


COMPLAINT MANAGEMENT SYSTEM
================================================================================

1. COMPLAINT SUBMISSION (Students)
   --------------------------------
   Database Collection: complaints

   Categories:
   - rash_driving: Dangerous driving behavior
   - lost_found: Lost items in bus
   - bus_issue: AC, seats, mechanical problems
   - other: Any other issues

   Working Flow:
   Student Experiences Issue → Opens Complaint Form → 
   Selects Category → Writes Description → Submits → 
   Complaint Sent to Admin → Status: "pending"

2. COMPLAINT PROCESSING (Admin)
   -----------------------------
   Admin Capabilities:
   - View all complaints
   - Filter by status (pending/in_progress/resolved)
   - Filter by category
   - Update status
   - Add admin response

   Working Flow:
   Admin Views Pending Complaints → Investigates Issue → 
   Updates Status to "in_progress" → Takes Action → 
   Adds Response → Marks as "resolved" → Student Notified

3. COMPLAINT TRACKING (Students)
   ------------------------------
   Students can:
   - View all their complaints
   - See current status
   - Read admin responses
   - Track resolution progress


LEAVE MANAGEMENT SYSTEM
================================================================================

1. DRIVER LEAVE REQUESTS
   ----------------------
   Database Collection: leave_requests

   Working Flow:
   Driver Needs Leave → Submits Request with Date & Reason → 
   Status: "pending" → Admin Receives Notification → 
   Admin Reviews Request

2. ADMIN LEAVE PROCESSING
   -----------------------
   Admin Options:
   - Approve with substitute driver assignment
   - Reject with reason
   - Add admin notes

   Working Flow:
   Admin Reviews Leave → Checks Substitute Availability → 
   Selects Substitute Driver → Approves Request → 
   Status: "approved" → Driver Notified → 
   Substitute Temporarily Assigned

3. LEAVE TRACKING
   ---------------
   Drivers can:
   - View all their leave requests
   - See approval status
   - Check substitute driver assigned
   - Cancel pending requests


ATTENDANCE SYSTEM
================================================================================

1. ATTENDANCE MARKING
   -------------------
   Working Flow:
   Student Boards Bus → Opens App → Marks Attendance → 
   System Records: Student ID, Bus Number, Route, Time, 
   GPS Location, Date → Stored in Database

2. ATTENDANCE TRACKING
   --------------------
   Database Collection: attendance

   Stored Information:
   - Student details (name, roll number)
   - Route and boarding point
   - Bus number
   - Date and time
   - Status: "Boarded"
   - GPS location coordinates

3. ATTENDANCE ANALYTICS
   ---------------------
   Students can view:
   - Total days
   - Present days
   - Attendance percentage
   - Complete history with dates

   Admin can view:
   - Individual student attendance
   - Route-wise attendance
   - Bus-wise attendance
   - Date range filtering


LOCATION TRACKING SYSTEM
================================================================================

1. BUS LOCATION UPDATES
   ---------------------
   Working Mechanism:
   Driver's Device with GPS → Sends Coordinates Periodically → 
   System Updates Bus Location in Database → 
   Students/Admin Can View Real-time Location

   Stored Data:
   - Latitude
   - Longitude
   - Timestamp of update

2. ROUTE COVERAGE TRACKING
   ------------------------
   System tracks:
   - Current stop index
   - Stops covered
   - Arrival times at each stop
   - Timeline of journey

   Working Flow:
   Bus Starts Route → Stop 1 Covered → Update currentStopIndex → 
   Stop 2 Covered → Update Again → Continue Until Complete


ADMIN DASHBOARD
================================================================================

1. OVERVIEW STATISTICS
   --------------------
   Real-time Display:
   - Total buses, running buses, idle buses
   - Total students, drivers, routes
   - Pending leave requests
   - Pending complaints
   - Today's attendance count

2. BUS MANAGEMENT
   ---------------
   Admin can:
   - View all buses with filters (route, status)
   - See detailed bus information
   - Assign/change drivers
   - Update bus routes
   - View real-time locations
   - Track coverage points

3. STUDENT MANAGEMENT
   -------------------
   Admin can:
   - View all students with filters
   - Update student details
   - Change bus assignments
   - Change routes
   - Update boarding points
   - View attendance records

4. DRIVER MANAGEMENT
   ------------------
   Admin can:
   - View all drivers
   - See assignment status
   - View driver details
   - Update driver information
   - Process leave requests
   - Assign substitute drivers

5. ROUTE MANAGEMENT
   -----------------
   Admin can:
   - View all routes
   - See route statistics (bus count, student count)
   - View detailed route information
   - See all buses and students on route


DATA FLOW DIAGRAMS
================================================================================

1. STUDENT MORNING WORKFLOW
   --------------------------
   Student Wakes Up
      ↓
   Opens TripSync App
      ↓
   Logs In (JWT Authentication)
      ↓
   Checks Driver Alerts (/api/messages/student/driver-messages)
      ↓
   Views Bus Location (/api/students/me/bus)
      ↓
   Checks Bus Chat (/api/messages/student/bus-chat)
      ↓
   Boards Bus at Stop
      ↓
   Marks Attendance (/api/attendance/board)
      ↓
   Journey to College

2. DRIVER DAILY WORKFLOW
   ----------------------
   Driver Arrives at Bus
      ↓
   Opens TripSync App
      ↓
   Logs In (JWT Authentication)
      ↓
   Views Schedule (/api/drivers/me/schedule)
      ↓
   Starts Route
      ↓
   [If Issue Occurs]
      ↓
   Sends Alert to Students (/api/messages/driver/send-to-students)
      ↓
   Continues Journey
      ↓
   Arrives at College

3. ADMIN MONITORING WORKFLOW
   --------------------------
   Admin Logs In
      ↓
   Views Dashboard (/api/admin/dashboard)
      ↓
   Checks Pending Complaints (/api/admin/complaints?status=pending)
      ↓
   Processes Complaints
      ↓
   Checks Leave Requests (/api/admin/leaves?status=pending)
      ↓
   Approves/Rejects Leaves
      ↓
   Monitors Bus Locations (/api/admin/buses/locations/all)
      ↓
   Sends Announcements (if needed)


DATABASE SCHEMA
================================================================================

1. USERS COLLECTION
   -----------------
   {
     "_id": ObjectId,
     "name": String,
     "email": String (unique),
     "password": String (hashed),
     "role": String (student/driver/admin),
     
     // Student-specific
     "roll_no": String (unique for students),
     "route": String,
     "boarding": String,
     "assignedBus": String,
     
     // Driver-specific
     "phone": String,
     
     "createdAt": DateTime
   }

2. BUSES COLLECTION
   -----------------
   {
     "_id": ObjectId,
     "number": String (unique),
     "route": String,
     "capacity": Number,
     "driverId": String,
     "currentLocation": {
       "latitude": Number,
       "longitude": Number,
       "timestamp": DateTime
     },
     "currentStopIndex": Number
   }

3. ROUTES COLLECTION
   ------------------
   {
     "_id": ObjectId,
     "name": String (unique),
     "stops": [
       {
         "name": String,
         "time": String,
         "latitude": Number,
         "longitude": Number
       }
     ],
     "coverageAreas": [String]
   }

4. MESSAGES COLLECTION
   --------------------
   {
     "_id": ObjectId,
     "groupId": String,
     "groupName": String,
     "sender": {
       "id": String,
       "name": String,
       "role": String,
       "rollNo": String (for students)
     },
     "content": String,
     "timestamp": DateTime,
     "busNumber": String,
     "route": String,
     "recipientType": String
   }

5. GROUPS COLLECTION
   ------------------
   {
     "_id": ObjectId,
     "groupId": String (unique),
     "groupName": String,
     "type": String (broadcast/route/driver_students/bus_students),
     "busNumber": String,
     "route": String,
     "recipientType": String,
     "lastMessage": String,
     "lastMessageTime": DateTime,
     "lastSender": String,
     "createdAt": DateTime
   }

6. COMPLAINTS COLLECTION
   ----------------------
   {
     "_id": ObjectId,
     "studentId": String,
     "studentName": String,
     "rollNo": String,
     "category": String,
     "description": String,
     "busNumber": String,
     "route": String,
     "status": String (pending/in_progress/resolved),
     "submittedAt": DateTime,
     "adminResponse": String,
     "updatedAt": DateTime,
     "updatedBy": String
   }

7. LEAVE_REQUESTS COLLECTION
   --------------------------
   {
     "_id": ObjectId,
     "driverId": String,
     "driverName": String,
     "busNumber": String,
     "route": String,
     "date": String (YYYY-MM-DD),
     "reason": String,
     "status": String (pending/approved/rejected),
     "submittedAt": DateTime,
     "approved": Boolean,
     "substituteDriverId": String,
     "adminNotes": String,
     "processedAt": DateTime,
     "processedBy": String
   }

8. ATTENDANCE COLLECTION
   ----------------------
   {
     "_id": ObjectId,
     "name": String,
     "roll_no": String,
     "route": String,
     "boarding": String,
     "busNumber": String,
     "date": String (YYYY-MM-DD),
     "time": String (HH:MM:SS),
     "status": String (Boarded),
     "location": {
       "lat": Number,
       "long": Number,
       "timestamp": DateTime
     },
     "timestamp": DateTime
   }


API ENDPOINT CATEGORIES
================================================================================

1. AUTHENTICATION (2 endpoints)
   - POST /api/auth/login
   - POST /api/auth/register

2. STUDENT ENDPOINTS (10+ endpoints)
   - GET /api/students/me
   - GET /api/students/me/route
   - GET /api/students/me/bus
   - GET /api/students/me/driver
   - GET /api/students/me/attendance
   - GET /api/messages/student/driver-messages
   - GET /api/messages/student/bus-chat
   - POST /api/messages/student/send-message
   - POST /api/messages/student/complaint
   - GET /api/messages/student/my-complaints

3. DRIVER ENDPOINTS (11 endpoints)
   - GET /api/drivers/me
   - GET /api/drivers/me/students
   - GET /api/drivers/me/bus-location
   - POST /api/messages/driver/send-to-students
   - GET /api/messages/driver/my-groups
   - POST /api/drivers/me/leave
   - GET /api/drivers/me/leaves
   - DELETE /api/drivers/me/leave/{id}
   - GET /api/drivers/me/schedule
   - GET /api/drivers/list (admin)
   - GET /api/drivers/{id} (admin)

4. ADMIN ENDPOINTS (25+ endpoints)
   - GET /api/admin/me
   - GET /api/admin/dashboard
   - GET /api/admin/statistics
   - POST /api/messages/admin/broadcast/all-students
   - POST /api/messages/admin/broadcast/all-drivers
   - POST /api/messages/admin/broadcast/route
   - POST /api/messages/admin/broadcast/route-drivers
   - GET /api/admin/complaints
   - PATCH /api/admin/complaints/{id}
   - GET /api/admin/buses
   - GET /api/admin/buses/{number}
   - PATCH /api/admin/buses/{number}
   - GET /api/admin/buses/{number}/location
   - GET /api/admin/buses/locations/all
   - GET /api/admin/students
   - PATCH /api/admin/students/{roll_no}
   - GET /api/admin/leaves
   - PATCH /api/admin/leaves/{id}
   - GET /api/admin/routes
   - GET /api/admin/routes/{name}

5. ATTENDANCE ENDPOINTS
   - POST /api/attendance/board
   - GET /api/attendance/student/{roll_no}


SECURITY FEATURES
================================================================================

1. AUTHENTICATION
   - JWT tokens with expiration
   - Secure password hashing (bcrypt/passlib)
   - Token-based session management

2. AUTHORIZATION
   - Role-based access control
   - Endpoint-level permission checks
   - Resource ownership validation

3. DATA VALIDATION
   - Pydantic models for input validation
   - Email uniqueness checks
   - Required field validation

4. DATA PRIVACY
   - Password never returned in responses
   - Students can only access their own data
   - Drivers can only see assigned students
   - Admin has full access with audit trail


REAL-WORLD USE CASES
================================================================================

1. SCENARIO: Bus Delay
   Student: Checks driver alerts, sees "Delayed 30 mins - tire issue"
   Driver: Sent alert immediately when problem occurred
   Admin: Monitors situation from dashboard
   Result: Students informed proactively, no confusion

2. SCENARIO: Lost Item
   Student: Posts in bus chat "Did anyone find blue notebook?"
   Bus Mate: Replies "Yes, I have it!"
   Alternative: If not found, submits formal complaint
   Admin: Reviews complaint, checks with driver
   Result: Item recovered through community or admin help

3. SCENARIO: Driver Leave
   Driver: Requests leave for medical appointment
   Admin: Receives request, checks substitute availability
   Admin: Assigns substitute driver, approves leave
   Students: See updated driver information
   Result: Seamless operation with substitute driver

4. SCENARIO: Route Change
   Admin: Traffic jam on usual route
   Admin: Broadcasts to route students "Alternative route today"
   Students: Receive notification, adjust accordingly
   Result: All students informed of change

5. SCENARIO: Emergency Announcement
   Admin: Campus closure due to weather
   Admin: Broadcasts to all students
   Students: Receive immediate notification
   Result: No students travel unnecessarily


SYSTEM ADVANTAGES
================================================================================

1. REAL-TIME COMMUNICATION
   - Instant alerts from drivers
   - Immediate admin announcements
   - Peer-to-peer student chat

2. EFFICIENT MANAGEMENT
   - Centralized control for admin
   - Automated attendance tracking
   - Easy complaint resolution

3. TRANSPARENCY
   - Real-time bus tracking
   - Visible complaint status
   - Leave request tracking

4. COMMUNITY BUILDING
   - Student chat groups per bus
   - Collaborative problem solving
   - Peer support network

5. DATA-DRIVEN DECISIONS
   - Attendance analytics
   - Complaint patterns
   - Route optimization possibilities


TECHNICAL HIGHLIGHTS
================================================================================

1. SCALABILITY
   - MongoDB for flexible schema
   - RESTful API architecture
   - Modular component design

2. PERFORMANCE
   - Efficient database queries
   - Pagination for large data sets
   - Indexed fields for fast lookups

3. MAINTAINABILITY
   - Clean code structure
   - Comprehensive documentation
   - Clear separation of concerns

4. EXTENSIBILITY
   - Easy to add new features
   - Plugin-style router system
   - Configurable settings


FUTURE ENHANCEMENTS
================================================================================

1. WebSocket Integration
   - Real-time message updates without polling
   - Live bus location tracking
   - Instant notifications

2. Mobile Applications
   - Native iOS and Android apps
   - Push notifications
   - Offline mode support

3. Advanced Analytics
   - Route optimization algorithms
   - Predictive maintenance alerts
   - Student travel pattern analysis

4. Parent Portal
   - View child's attendance
   - Receive bus alerts
   - Track bus location

5. File Attachments
   - Share documents in chat
   - Upload images for complaints
   - Driver license/document management


CONCLUSION
================================================================================

TripSync is a comprehensive solution that brings together students, drivers, 
and administrators on a unified platform. Through real-time communication, 
location tracking, attendance management, and complaint resolution, it 
streamlines college bus operations while building a connected community.

The system's modular architecture ensures scalability, while role-based access 
control maintains security and privacy. With its focus on both official 
communication and peer interaction, TripSync addresses the complete spectrum 
of college transportation needs.


TECHNICAL SUMMARY
================================================================================

Backend Framework: FastAPI (Python)
Database: MongoDB
Authentication: JWT
API Style: RESTful
Total Endpoints: 45+
User Roles: 3 (Student, Driver, Admin)
Database Collections: 8
Message Group Types: 6
Security: Role-based + Token-based

Development Status: Production Ready
Documentation: Complete with Examples
Testing: API samples provided for all endpoints


================================================================================
                              END OF DOCUMENT
================================================================================

For detailed API documentation with sample inputs and outputs, refer to:
- STUDENT_MESSAGING_GUIDE.md
- MESSAGING_ENDPOINTS_SAMPLES.md
- API_SAMPLES.md
- QUICK_REFERENCE.md

For implementation details, see:
- app/routers/ - All endpoint implementations
- app/models/ - Data models
- app/core/ - Security and configuration

================================================================================
